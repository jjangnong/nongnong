<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>김진영&장은영 결혼식 예매사이트</title>
<link href="https://fonts.googleapis.com/css2?family=Dongle:wght@700&display=swap" rel="stylesheet">
<style>
body {margin:0; font-family:'Noto Sans KR',sans-serif; background:url('https://raw.githubusercontent.com/jjangnong/nongnong/refs/heads/main/0UNIQ7164.jpg') no-repeat center center fixed; background-size:cover; color:white;}
header {background:rgba(0,0,0,0.2); padding:20px; text-align:center; font-size:1.5em; border-radius:8px; max-width:600px; margin:20px auto 0 auto; font-family:'Dongle',sans-serif; font-weight:700;}
form {background:rgba(0,0,0,0.2); width:90%; max-width:600px; margin:40px auto; padding:20px; border-radius:8px; box-sizing:border-box;}
label {display:block; margin-top:15px; font-weight:600;}
input, textarea {width:100%; padding:8px; margin-top:5px; border:none; border-radius:4px; box-sizing:border-box;}
button {margin-top:20px; width:100%; padding:12px; background-color:#637FDE; border:none; color:white; font-size:1em; border-radius:4px; cursor:pointer;}
button:hover {background-color:#637FDE;}
input[type="date"] {background-color:white; color:black;}
</style>
</head>
<body>

<header>
2025.12.28. 김진영&장은영 결혼식 예매사이트<br>
티켓 수령 날짜를 지정해주시면 확인 후 확정문자 드리겠습니다:D
</header>

<form id="reservation-form">
<label for="name">이름(단체명)</label>
<input type="text" id="name" name="name" required>
<label for="people">예매 인원</label>
<input type="number" id="people" name="people" min="1" max="10" value="1" required>
<label for="date">티켓 수령 날짜 (2025-10-01 ~ 2025-12-21)</label>
<input type="date" id="date" name="date" min="2025-10-01" max="2025-12-21" required>
<label for="message">요청사항</label>
<textarea id="message" name="message" rows="4" placeholder="짱농진농에게 한마디♥" required></textarea>
<button type="submit">예매하기</button>
</form>

<script>
const AIRTABLE_API_URL = "https://api.airtable.com/v0/appp1PlTQh49Nv4sj/Table%201";
const AIRTABLE_TOKEN = "patHoENJMNA4WGKKq.81c4d38e6bf72c3f55a05b9e11de11245099b2cc5e49039e100906180dea6857";

const bookedDates = [];
const form = document.getElementById('reservation-form');
const dateInput = document.getElementById('date');

// 1️⃣ 예약된 날짜 목록 불러오기
async function fetchBookedDates() {
  try {
    const res = await fetch(`${AIRTABLE_API_URL}?fields[]=date`, {
      headers: {
        Authorization: `Bearer ${AIRTABLE_TOKEN}`
      }
    });
    const data = await res.json();
    const dates = data.records.map(record => record.fields.date);
    bookedDates.push(...dates);
  } catch (err) {
    console.error("예약 날짜 불러오기 오류", err);
  }
}

fetchBookedDates();

// 2️⃣ 날짜 중복 확인
dateInput.addEventListener('input', () => {
  if (bookedDates.includes(dateInput.value)) {
    alert('이미 예약된 날짜입니다. 다른 날짜를 선택해주세요.');
    dateInput.value = '';
  }
});

// 3️⃣ 폼 제출 (Airtable에 저장)
form.addEventListener('submit', async e => {
  e.preventDefault();

  const name = form.name.value.trim();
  const people = parseInt(form.people.value);
  const date = form.date.value;
  const message = form.message.value.trim();

  if (!name || !people || !date || !message) {
    alert("모든 항목을 입력해주세요.");
    return;
  }

  try {
    const res = await fetch(AIRTABLE_API_URL, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${AIRTABLE_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        records: [
          {
            fields: {
              "Name": name,
              "people": people,
              "date": date,
              "message": message
            }
          }
        ]
      })
    });

    const result = await res.json();

    if (res.ok) {
      alert(`✅ 예매 완료!\n👤 이름: ${name}\n📅 날짜: ${date}\n💬 메시지: ${message}`);
      form.reset();
      bookedDates.push(date); // 새로 예약된 날짜 추가
    } else {
      console.error(result);
      alert("에러 발생: " + (result.error?.message || "알 수 없는 에러"));
    }
  } catch (err) {
    console.error(err);
    alert("예약 처리 중 오류가 발생했습니다.");
  }
});
</script>


</body>
</html>
